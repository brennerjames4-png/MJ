<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJ - Music Jam</title>
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --green: #1db954;
    --green-dark: #1aa34a;
    --bg: #121212;
    --card: #1e1e1e;
    --card-hover: #282828;
    --text: #ffffff;
    --text-dim: #b3b3b3;
    --border: #333;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

header {
    text-align: center;
    padding: 20px 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
}

header h1 {
    font-size: 2.5rem;
    color: var(--green);
    letter-spacing: 4px;
}

.subtitle {
    color: var(--text-dim);
    margin-top: 4px;
}

.user-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 12px;
}

.avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.btn {
    background: var(--card-hover);
    color: var(--text);
    border: 1px solid var(--border);
    padding: 10px 20px;
    border-radius: 24px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}

.btn:hover { background: var(--border); }

.btn-sm { padding: 6px 14px; font-size: 12px; }

.btn-spotify {
    background: var(--green);
    border: none;
    color: #fff;
    font-weight: 600;
}

.btn-spotify:hover { background: var(--green-dark); }

.hero {
    text-align: center;
    padding: 80px 20px;
}

.hero h2 { font-size: 1.8rem; margin-bottom: 12px; }
.hero p { color: var(--text-dim); margin-bottom: 24px; max-width: 500px; margin-left: auto; margin-right: auto; }

/* Tabs */
.tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 24px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0;
}

.tab {
    background: none;
    border: none;
    color: var(--text-dim);
    padding: 12px 20px;
    cursor: pointer;
    font-size: 14px;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
}

.tab:hover { color: var(--text); }
.tab.active { color: var(--green); border-bottom-color: var(--green); }

.tab-content { display: none; }
.tab-content.active { display: block; }

/* Song cards */
.song-list { display: flex; flex-direction: column; gap: 8px; }

.song-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: var(--card);
    border-radius: 8px;
    transition: background 0.2s;
}

.song-card:hover { background: var(--card-hover); }

.song-card img {
    width: 56px;
    height: 56px;
    border-radius: 4px;
    object-fit: cover;
}

.song-info { flex: 1; min-width: 0; }
.song-info .name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.song-info .artist { color: var(--text-dim); font-size: 13px; }
.song-info .meta { color: var(--text-dim); font-size: 12px; margin-top: 4px; }

.song-actions { display: flex; gap: 6px; flex-shrink: 0; }

.reaction-btn {
    background: var(--card-hover);
    border: 1px solid var(--border);
    color: var(--text-dim);
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.reaction-btn:hover { border-color: var(--green); color: var(--green); }
.reaction-btn.active { background: var(--green); border-color: var(--green); color: #fff; }

.share-btn {
    background: none;
    border: 1px solid var(--green);
    color: var(--green);
    padding: 6px 14px;
    border-radius: 16px;
    cursor: pointer;
    font-size: 13px;
}

.share-btn:hover { background: var(--green); color: #fff; }

/* Search */
.search-box {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.search-box input {
    flex: 1;
    padding: 12px 16px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 24px;
    color: var(--text);
    font-size: 14px;
    outline: none;
}

.search-box input:focus { border-color: var(--green); }

/* Share form */
.share-form {
    margin-top: 16px;
    padding: 16px;
    background: var(--card);
    border-radius: 8px;
}

.share-form h3 { margin-bottom: 8px; font-size: 14px; }

.share-form select, .share-form textarea {
    width: 100%;
    padding: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    margin-bottom: 8px;
}

.share-form textarea { resize: vertical; min-height: 60px; }

/* Compare */
.compare-picker {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 24px;
}

.compare-picker select {
    flex: 1;
    padding: 10px;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
}

.compat-score {
    text-align: center;
    padding: 32px;
}

.compat-score #compat-number {
    font-size: 4rem;
    font-weight: 700;
    color: var(--green);
}

.compat-score span:last-of-type { font-size: 2rem; color: var(--green); }
.compat-score p { color: var(--text-dim); margin-top: 4px; }

.compare-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.compare-grid h3 {
    color: var(--green);
    font-size: 14px;
    margin-bottom: 8px;
}

.compare-grid ul {
    list-style: none;
    color: var(--text-dim);
    font-size: 13px;
}

.compare-grid li {
    padding: 4px 0;
    border-bottom: 1px solid var(--border);
}

.hidden { display: none; }
.loading { color: var(--text-dim); text-align: center; padding: 24px; }

a.spotify-link {
    color: var(--green);
    text-decoration: none;
    font-size: 12px;
}

a.spotify-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MJ</h1>
            <p class="subtitle">Music Jam - Compare & Share</p>
            {% if logged_in %}
            <div class="user-bar">
                {% if user.image_url %}
                <img src="{{ user.image_url }}" alt="avatar" class="avatar">
                {% endif %}
                <span>{{ user.display_name }}</span>
                <a href="/logout" class="btn btn-sm">Logout</a>
            </div>
            {% endif %}
        </header>

        {% if not logged_in %}
        <div class="hero">
            <h2>Compare your music taste with friends</h2>
            <p>Connect your Spotify account to share songs, rate each other's picks, and see how your tastes stack up.</p>
            <a href="/login" class="btn btn-spotify">Connect with Spotify</a>
        </div>
        {% else %}
        <nav class="tabs">
            <button class="tab active" data-tab="feed">Feed</button>
            <button class="tab" data-tab="share">Share a Song</button>
            <button class="tab" data-tab="compare">Compare</button>
            <button class="tab" data-tab="my-top">My Top Tracks</button>
        </nav>

        <!-- FEED TAB -->
        <section id="feed" class="tab-content active">
            <h2>Shared Songs</h2>
            <div id="feed-list" class="song-list">
                <p class="loading">Loading...</p>
            </div>
        </section>

        <!-- SHARE TAB -->
        <section id="share" class="tab-content">
            <h2>Share a Song</h2>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search for a song...">
                <button id="search-btn" class="btn">Search</button>
            </div>
            <div id="search-results" class="song-list"></div>

            <div id="share-form" class="share-form hidden">
                <h3>Send to:</h3>
                <select id="share-to"></select>
                <textarea id="share-message" placeholder="Add a message (optional)"></textarea>
                <button id="send-btn" class="btn btn-spotify">Send Song</button>
            </div>
        </section>

        <!-- COMPARE TAB -->
        <section id="compare" class="tab-content">
            <h2>Compare Tastes</h2>
            <div class="compare-picker">
                <label>Compare with:</label>
                <select id="compare-user"></select>
                <button id="compare-btn" class="btn">Compare</button>
            </div>
            <div id="compare-results" class="hidden">
                <div class="compat-score">
                    <span id="compat-number">0</span><span>%</span>
                    <p>compatibility</p>
                </div>
                <div class="compare-grid">
                    <div>
                        <h3>Shared Artists</h3>
                        <ul id="shared-artists"></ul>
                    </div>
                    <div>
                        <h3>Your Top Genres</h3>
                        <ul id="my-genres"></ul>
                    </div>
                    <div>
                        <h3>Their Top Genres</h3>
                        <ul id="their-genres"></ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- MY TOP TAB -->
        <section id="my-top" class="tab-content">
            <h2>My Top Tracks</h2>
            <div id="top-tracks-list" class="song-list">
                <p class="loading">Loading...</p>
            </div>
        </section>
        {% endif %}
    </div>

    {% if logged_in %}
    <script>
        const MY_ID = "{{ user.id }}";
    </script>
    <script>
// --- Tab switching ---
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
    });
});

// --- Helpers ---
async function api(url, opts = {}) {
    const resp = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        ...opts,
    });
    if (!resp.ok) throw new Error(`API error ${resp.status}`);
    return resp.json();
}

function songCard(track, actions = '') {
    return `
        <div class="song-card" data-track-id="${track.id || ''}">
            ${track.album_image ? `<img src="${track.album_image}" alt="">` : ''}
            <div class="song-info">
                <div class="name">${track.name || track.track_name || ''}</div>
                <div class="artist">${track.artist || track.artist_name || ''}</div>
                ${track.meta ? `<div class="meta">${track.meta}</div>` : ''}
                ${track.spotify_url ? `<a class="spotify-link" href="${track.spotify_url}" target="_blank">Open in Spotify</a>` : ''}
            </div>
            <div class="song-actions">${actions}</div>
        </div>
    `;
}

// --- Load feed ---
async function loadFeed() {
    const el = document.getElementById('feed-list');
    try {
        const songs = await api('/api/shared');
        if (songs.length === 0) {
            el.innerHTML = '<p class="loading">No shared songs yet. Share one!</p>';
            return;
        }
        el.innerHTML = songs.map(s => {
            const isMine = s.from_user_id === MY_ID;
            const direction = isMine ? `You sent` : `From ${s.from_name}`;
            const meta = `${direction} ${s.message ? '· "' + s.message + '"' : ''} · ${new Date(s.created_at).toLocaleDateString()}`;
            const likeActive = s.my_reaction === 'like' ? 'active' : '';
            const dislikeActive = s.my_reaction === 'dislike' ? 'active' : '';
            return songCard(
                { ...s, name: s.track_name, artist: s.artist_name, meta },
                `<button class="reaction-btn ${likeActive}" onclick="react(${s.id}, 'like', this)" title="Like">&#x1F44D;</button>
                 <button class="reaction-btn ${dislikeActive}" onclick="react(${s.id}, 'dislike', this)" title="Dislike">&#x1F44E;</button>`
            );
        }).join('');
    } catch (e) {
        el.innerHTML = '<p class="loading">Could not load feed.</p>';
    }
}

async function react(songId, reaction, btn) {
    await api('/api/react', {
        method: 'POST',
        body: JSON.stringify({ shared_song_id: songId, reaction }),
    });
    const parent = btn.parentElement;
    parent.querySelectorAll('.reaction-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// --- Search & share ---
let selectedTrack = null;

document.getElementById('search-btn').addEventListener('click', async () => {
    const q = document.getElementById('search-input').value.trim();
    if (!q) return;
    const results = await api(`/api/search?q=${encodeURIComponent(q)}`);
    document.getElementById('search-results').innerHTML = results.map(t =>
        songCard(t, `<button class="share-btn" onclick='selectTrack(${JSON.stringify(t).replace(/'/g, "&#39;")})'>Share</button>`)
    ).join('');
});

document.getElementById('search-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('search-btn').click();
});

window.selectTrack = async function(track) {
    selectedTrack = track;
    document.getElementById('share-form').classList.remove('hidden');
    const users = await api('/api/users');
    const sel = document.getElementById('share-to');
    sel.innerHTML = users.map(u => `<option value="${u.id}">${u.display_name}</option>`).join('');
    if (users.length === 0) sel.innerHTML = '<option disabled>No other users connected yet</option>';
};

document.getElementById('send-btn').addEventListener('click', async () => {
    if (!selectedTrack) return;
    const to = document.getElementById('share-to').value;
    const msg = document.getElementById('share-message').value;
    await api('/api/share', {
        method: 'POST',
        body: JSON.stringify({
            to_user_id: to,
            track_id: selectedTrack.id,
            track_name: selectedTrack.name,
            artist_name: selectedTrack.artist,
            album_image: selectedTrack.album_image,
            preview_url: selectedTrack.preview_url,
            spotify_url: selectedTrack.spotify_url,
            message: msg,
        }),
    });
    document.getElementById('share-form').classList.add('hidden');
    document.getElementById('share-message').value = '';
    selectedTrack = null;
    alert('Song shared!');
    document.querySelector('[data-tab="feed"]').click();
    loadFeed();
});

// --- Compare ---
async function loadCompareUsers() {
    try {
        const users = await api('/api/users');
        const sel = document.getElementById('compare-user');
        sel.innerHTML = users.map(u => `<option value="${u.id}">${u.display_name}</option>`).join('');
        if (users.length === 0) sel.innerHTML = '<option disabled>No other users to compare with</option>';
    } catch (e) {}
}

document.getElementById('compare-btn').addEventListener('click', async () => {
    const otherId = document.getElementById('compare-user').value;
    if (!otherId) return;
    try {
        const data = await api(`/api/compare/${otherId}`);
        document.getElementById('compare-results').classList.remove('hidden');
        document.getElementById('compat-number').textContent = data.compatibility_score;
        document.getElementById('shared-artists').innerHTML = data.shared_artists.length
            ? data.shared_artists.map(a => `<li>${a}</li>`).join('')
            : '<li>No shared artists found</li>';
        document.getElementById('my-genres').innerHTML = data.my_top_genres.map(g => `<li>${g}</li>`).join('');
        document.getElementById('their-genres').innerHTML = data.their_top_genres.map(g => `<li>${g}</li>`).join('');
    } catch (e) {
        alert('Could not compare. Make sure both users are connected.');
    }
});

// --- My top tracks ---
async function loadTopTracks() {
    const el = document.getElementById('top-tracks-list');
    try {
        const tracks = await api('/api/me/top-tracks');
        el.innerHTML = tracks.length
            ? tracks.map((t, i) => songCard({ ...t, meta: `#${i + 1}` })).join('')
            : '<p class="loading">No top tracks data yet. Listen to more music!</p>';
    } catch (e) {
        el.innerHTML = '<p class="loading">Could not load top tracks.</p>';
    }
}

// --- Init ---
loadFeed();
loadTopTracks();
loadCompareUsers();
    </script>
    {% endif %}
</body>
</html>
