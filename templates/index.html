<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJ Tunes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Josefin+Sans:wght@300;400;600&family=Sacramento&display=swap" rel="stylesheet">
    <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
    --cream: #faf3e8;
    --warm-white: #f5ead6;
    --parchment: #ede0cc;
    --ink: #1a1510;
    --ink-soft: #3d3425;
    --ink-dim: #7a6b56;
    --prism: #c06c3e;
    --prism-glow: #d4854f;
    --deep-blue: #2c3e6b;
    --sky-blue: #6b8cae;
    --rose: #b5544a;
    --sage: #6b7c5e;
    --gold-leaf: #c49b3c;
    --violet: #7b6094;
    --border: #d4c5aa;
    --border-light: #e8dcc8;
}

body {
    font-family: 'Cormorant Garamond', 'Georgia', serif;
    background: var(--cream);
    color: var(--ink);
    min-height: 100vh;
    background-image:
        radial-gradient(ellipse at 15% 20%, rgba(192,108,62,0.07) 0%, transparent 50%),
        radial-gradient(ellipse at 85% 70%, rgba(44,62,107,0.05) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(123,96,148,0.03) 0%, transparent 60%);
}

/* Subtle paper texture */
body::before {
    content: '';
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='paper'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23paper)' opacity='0.02'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
}

.container {
    max-width: 780px;
    margin: 0 auto;
    padding: 24px 20px;
    position: relative;
    z-index: 1;
}

/* --- HEADER --- */
header {
    text-align: center;
    padding: 40px 0 28px;
    margin-bottom: 32px;
    position: relative;
}

header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 15%;
    right: 15%;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--border), var(--prism), var(--border), transparent);
}

header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 3.8rem;
    font-weight: 900;
    letter-spacing: 3px;
    color: var(--ink);
    line-height: 1;
    position: relative;
}

header h1 span.accent {
    font-family: 'Sacramento', cursive;
    font-size: 2rem;
    color: var(--prism);
    display: block;
    margin-top: -4px;
    font-weight: 400;
    letter-spacing: 4px;
}

.subtitle {
    font-family: 'Josefin Sans', sans-serif;
    color: var(--ink-dim);
    margin-top: 10px;
    font-size: 0.7rem;
    letter-spacing: 6px;
    text-transform: uppercase;
    font-weight: 300;
}

.user-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    margin-top: 18px;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.85rem;
    letter-spacing: 2px;
    font-weight: 300;
    color: var(--ink-soft);
}

.avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: 2px solid var(--border);
    box-shadow: 0 1px 6px rgba(0,0,0,0.1);
}

/* --- PRISM BAR (Pink Floyd inspired) --- */
.prism-bar {
    height: 3px;
    margin: 0 auto 8px;
    width: 200px;
    background: linear-gradient(90deg,
        #e74c3c 0%, #e67e22 17%, #f1c40f 33%,
        #2ecc71 50%, #3498db 67%, #9b59b6 83%, #e74c3c 100%);
    border-radius: 2px;
    opacity: 0.6;
}

/* --- BUTTONS --- */
.btn {
    font-family: 'Josefin Sans', sans-serif;
    background: transparent;
    color: var(--ink-soft);
    border: 1px solid var(--border);
    padding: 10px 26px;
    border-radius: 2px;
    cursor: pointer;
    font-size: 12px;
    letter-spacing: 3px;
    transition: all 0.4s;
    text-transform: uppercase;
    font-weight: 400;
}

.btn:hover {
    background: var(--ink);
    color: var(--cream);
    border-color: var(--ink);
}

.btn-sm { padding: 5px 14px; font-size: 10px; letter-spacing: 2px; }

.btn-spotify {
    background: var(--ink);
    border: none;
    color: var(--cream);
    font-weight: 400;
    padding: 16px 40px;
    font-size: 13px;
    letter-spacing: 4px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s;
}

.btn-spotify:hover {
    background: var(--prism);
    box-shadow: 0 4px 24px rgba(192,108,62,0.25);
    transform: translateY(-1px);
}

/* --- HERO --- */
.hero {
    text-align: center;
    padding: 50px 20px 70px;
}

.hero h2 {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    margin-bottom: 20px;
    color: var(--ink);
    line-height: 1.4;
    font-weight: 400;
    font-style: italic;
}

.hero p {
    font-family: 'Cormorant Garamond', serif;
    color: var(--ink-dim);
    margin-bottom: 36px;
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
    font-size: 1.1rem;
    line-height: 1.8;
    font-weight: 300;
}

.hero-tagline {
    font-family: 'Sacramento', cursive;
    color: var(--prism);
    font-size: 1.3rem;
    margin-top: 28px;
}

.hero-icons {
    margin-top: 16px;
    font-size: 0.75rem;
    letter-spacing: 4px;
    color: var(--ink-dim);
    font-family: 'Josefin Sans', sans-serif;
    font-weight: 300;
    text-transform: uppercase;
}

/* --- TABS --- */
.tabs {
    display: flex;
    gap: 0;
    margin-bottom: 32px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0;
}

.tab {
    font-family: 'Josefin Sans', sans-serif;
    background: none;
    border: none;
    color: var(--ink-dim);
    padding: 14px 22px;
    cursor: pointer;
    font-size: 11px;
    letter-spacing: 3px;
    border-bottom: 2px solid transparent;
    transition: all 0.3s;
    text-transform: uppercase;
    font-weight: 400;
}

.tab:hover {
    color: var(--ink);
}

.tab.active {
    color: var(--prism);
    border-bottom-color: var(--prism);
}

.tab-content { display: none; animation: fadeIn 0.4s ease; }
.tab-content.active { display: block; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Section headers */
.tab-content h2 {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    margin-bottom: 24px;
    color: var(--ink);
    font-weight: 400;
    font-style: italic;
    position: relative;
    padding-bottom: 12px;
}

.tab-content h2::after {
    content: '';
    position: absolute;
    bottom: 0; left: 0;
    width: 40px; height: 2px;
    background: linear-gradient(90deg, var(--prism), var(--gold-leaf));
}

/* --- SONG CARDS --- */
.song-list { display: flex; flex-direction: column; gap: 6px; }

.song-card {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px 18px;
    background: rgba(255,255,255,0.5);
    border-radius: 3px;
    border: 1px solid var(--border-light);
    transition: all 0.3s;
    position: relative;
}

.song-card:hover {
    background: rgba(255,255,255,0.8);
    border-color: var(--border);
    box-shadow: 0 2px 16px rgba(0,0,0,0.04);
}

.song-card img {
    width: 56px;
    height: 56px;
    border-radius: 2px;
    object-fit: cover;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}

.song-info { flex: 1; min-width: 0; }

.song-info .name {
    font-family: 'Playfair Display', serif;
    font-weight: 600;
    font-size: 1.05rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    color: var(--ink);
}

.song-info .artist {
    font-family: 'Josefin Sans', sans-serif;
    color: var(--prism);
    font-size: 11px;
    margin-top: 3px;
    letter-spacing: 1px;
    font-weight: 300;
    text-transform: uppercase;
}

.song-info .meta {
    color: var(--ink-dim);
    font-size: 12px;
    margin-top: 4px;
    font-style: italic;
    font-weight: 300;
}

.song-actions { display: flex; gap: 8px; flex-shrink: 0; }

.reaction-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--ink-dim);
    width: 38px;
    height: 38px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.reaction-btn:hover {
    border-color: var(--prism);
    color: var(--prism);
    transform: scale(1.08);
}

.reaction-btn.active {
    background: var(--prism);
    border-color: var(--prism);
    color: #fff;
    box-shadow: 0 2px 10px rgba(192,108,62,0.3);
}

.share-btn {
    font-family: 'Josefin Sans', sans-serif;
    background: none;
    border: 1px solid var(--prism);
    color: var(--prism);
    padding: 7px 18px;
    border-radius: 2px;
    cursor: pointer;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: all 0.3s;
}

.share-btn:hover {
    background: var(--prism);
    color: #fff;
}

/* --- SEARCH --- */
.search-box {
    display: flex;
    gap: 10px;
    margin-bottom: 24px;
}

.search-box input {
    flex: 1;
    padding: 14px 20px;
    background: rgba(255,255,255,0.6);
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--ink);
    font-family: 'Cormorant Garamond', serif;
    font-size: 16px;
    outline: none;
    transition: all 0.3s;
}

.search-box input::placeholder {
    color: var(--ink-dim);
    font-style: italic;
}

.search-box input:focus {
    border-color: var(--prism);
    background: rgba(255,255,255,0.9);
    box-shadow: 0 0 0 3px rgba(192,108,62,0.08);
}

/* --- SHARE FORM --- */
.share-form {
    margin-top: 24px;
    padding: 24px;
    background: rgba(255,255,255,0.4);
    border-radius: 3px;
    border: 1px solid var(--border-light);
}

.share-form h3 {
    font-family: 'Josefin Sans', sans-serif;
    margin-bottom: 14px;
    font-size: 11px;
    letter-spacing: 3px;
    color: var(--ink-soft);
    text-transform: uppercase;
    font-weight: 400;
}

.share-form select, .share-form textarea {
    width: 100%;
    padding: 12px;
    background: rgba(255,255,255,0.6);
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--ink);
    font-family: 'Cormorant Garamond', serif;
    font-size: 15px;
    margin-bottom: 10px;
}

.share-form textarea {
    resize: vertical;
    min-height: 60px;
}

.share-form textarea::placeholder { font-style: italic; color: var(--ink-dim); }

/* --- COMPARE --- */
.compare-picker {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 28px;
    font-family: 'Josefin Sans', sans-serif;
    letter-spacing: 2px;
    font-size: 11px;
    text-transform: uppercase;
}

.compare-picker label {
    color: var(--ink-soft);
    font-weight: 400;
}

.compare-picker select {
    flex: 1;
    padding: 12px;
    background: rgba(255,255,255,0.6);
    border: 1px solid var(--border);
    border-radius: 2px;
    color: var(--ink);
    font-family: 'Cormorant Garamond', serif;
    font-size: 15px;
}

.compat-score {
    text-align: center;
    padding: 44px 20px;
    position: relative;
}

.compat-score::before {
    content: '';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 160px; height: 160px;
    border-radius: 50%;
    border: 1px solid var(--border);
}

.compat-score #compat-number {
    font-family: 'Playfair Display', serif;
    font-size: 5rem;
    font-weight: 900;
    color: var(--prism);
}

.compat-score span:last-of-type {
    font-family: 'Playfair Display', serif;
    font-size: 2rem;
    color: var(--prism);
    font-weight: 300;
}

.compat-score p {
    font-family: 'Sacramento', cursive;
    color: var(--ink-dim);
    margin-top: 8px;
    font-size: 1.2rem;
}

.compare-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 24px;
    margin-top: 28px;
}

.compare-grid h3 {
    font-family: 'Josefin Sans', sans-serif;
    color: var(--prism);
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 12px;
    font-weight: 400;
    border-bottom: 1px solid var(--border-light);
    padding-bottom: 8px;
}

.compare-grid ul {
    list-style: none;
    color: var(--ink-dim);
    font-size: 14px;
}

.compare-grid li {
    padding: 6px 0;
    border-bottom: 1px solid var(--border-light);
    transition: color 0.2s;
    font-weight: 300;
}

.compare-grid li:hover { color: var(--ink); }

/* --- COMBINED CHART --- */
.combined-chart {
    margin-top: 40px;
    padding-top: 32px;
    border-top: 1px solid var(--border-light);
}

.chart-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.6rem;
    font-weight: 700;
    color: var(--ink);
    text-align: center;
    margin-bottom: 4px;
}

.chart-subtitle {
    font-family: 'Cormorant Garamond', serif;
    font-size: 0.95rem;
    color: var(--ink-dim);
    text-align: center;
    font-style: italic;
    margin-bottom: 24px;
}

.combined-chart .song-card {
    position: relative;
}

.combined-chart .song-card .combined-rank {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-weight: 900;
    color: var(--prism);
    min-width: 36px;
    text-align: center;
    flex-shrink: 0;
}

.combined-chart .song-card .rank-detail {
    font-family: 'Josefin Sans', sans-serif;
    font-size: 9px;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--ink-dim);
    margin-top: 2px;
}

.combined-chart .song-card .rank-detail .shared-badge {
    color: var(--prism);
    font-weight: 600;
}

.combined-chart .song-card.is-shared {
    background: rgba(183, 101, 77, 0.04);
    border-left: 3px solid var(--prism);
}

.combined-chart .song-card.chart-hidden {
    display: none;
}

.btn-expand {
    display: block;
    width: 100%;
    margin-top: 16px;
    padding: 14px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--ink-soft);
    font-family: 'Josefin Sans', sans-serif;
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 2px;
}

.btn-expand:hover {
    border-color: var(--prism);
    color: var(--prism);
}

.btn-expand span {
    font-weight: 300;
    opacity: 0.7;
}

/* --- JUST PLAYED SIDE BY SIDE --- */
.recent-side-by-side {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

@media (max-width: 700px) {
    .recent-side-by-side {
        grid-template-columns: 1fr;
    }
}

.recent-column {
    min-width: 0;
}

.recent-col-header {
    font-family: 'Josefin Sans', sans-serif;
    color: var(--prism);
    font-size: 10px;
    letter-spacing: 3px;
    text-transform: uppercase;
    font-weight: 400;
    border-bottom: 1px solid var(--border-light);
    padding-bottom: 8px;
    margin-bottom: 12px;
    text-align: center;
}

.recent-column .song-card img {
    width: 40px;
    height: 40px;
}

.recent-column .song-card .name {
    font-size: 13px;
}

.recent-column .song-card .artist {
    font-size: 11px;
}

/* --- UTILITIES --- */
.hidden { display: none; }

.loading {
    color: var(--ink-dim);
    text-align: center;
    padding: 40px;
    font-style: italic;
    font-size: 1.05rem;
    font-weight: 300;
}

a.spotify-link {
    font-family: 'Josefin Sans', sans-serif;
    color: var(--sage);
    text-decoration: none;
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    transition: color 0.2s;
}

a.spotify-link:hover {
    color: var(--prism);
}

/* --- SCROLLBAR --- */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--cream); }
::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover { background: var(--ink-dim); }

/* --- FOOTER QUOTE --- */
.footer-quote {
    text-align: center;
    margin-top: 60px;
    padding: 20px 0;
    border-top: 1px solid var(--border-light);
    font-family: 'Cormorant Garamond', serif;
    font-style: italic;
    color: var(--ink-dim);
    font-size: 0.95rem;
    font-weight: 300;
    letter-spacing: 0.5px;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.footer-quote .quote-text {
    transition: opacity 0.6s ease;
    opacity: 1;
}

.footer-quote .quote-text.fade-out {
    opacity: 0;
}

.footer-quote .attr {
    display: block;
    margin-top: 6px;
    font-style: normal;
    font-family: 'Josefin Sans', sans-serif;
    font-size: 0.6rem;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--ink-dim);
    opacity: 0.6;
    transition: opacity 0.6s ease;
}

.footer-quote .attr.fade-out {
    opacity: 0;
}

/* --- RESPONSIVE --- */
@media (max-width: 600px) {
    header h1 { font-size: 2.6rem; }
    .hero h2 { font-size: 1.5rem; }
    .tabs { flex-wrap: wrap; }
    .tab { padding: 10px 14px; font-size: 10px; letter-spacing: 2px; }
    .song-card { padding: 12px; gap: 12px; }
    .song-card img { width: 48px; height: 48px; }
    .compare-picker { flex-wrap: wrap; }
    .prism-bar { width: 140px; }
}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="prism-bar"></div>
            <h1>MJ Tunes <span class="accent">for the record</span></h1>
            <p class="subtitle">A listening room for two</p>
            {% if logged_in %}
            <div class="user-bar">
                {% if user.image_url %}
                <img src="{{ user.image_url }}" alt="avatar" class="avatar">
                {% endif %}
                <span>{{ user.display_name }}</span>
                <a href="/logout" class="btn btn-sm">Logout</a>
            </div>
            {% endif %}
        </header>

        {% if not logged_in %}
        <div class="hero">
            <h2>"Music is the shorthand of emotion"</h2>
            <p>Connect your Spotify, share the songs that move you, hear what moves your friend, and discover where your musical souls overlap.</p>
            <a href="/login" class="btn btn-spotify">Connect with Spotify</a>
            <p class="hero-tagline">the long and winding road starts here</p>
            <p class="hero-icons">Cat Stevens / Pink Floyd / Led Zeppelin / The Beatles</p>
        </div>
        {% else %}
        <nav class="tabs">
            <button class="tab active" data-tab="feed">The Record</button>
            <button class="tab" data-tab="share">Send a Song</button>
            <button class="tab" data-tab="compare">Side by Side</button>
            <button class="tab" data-tab="my-top">My Catalogue</button>
        </nav>

        <!-- FEED TAB -->
        <section id="feed" class="tab-content active">
            <h2>Lately, between us</h2>
            <div id="feed-list" class="song-list">
                <p class="loading">Dropping the needle...</p>
            </div>
        </section>

        <!-- SHARE TAB -->
        <section id="share" class="tab-content">
            <h2>Send something beautiful</h2>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search for a song that says it all...">
                <button id="search-btn" class="btn">Find</button>
            </div>
            <div id="search-results" class="song-list"></div>

            <div id="share-form" class="share-form hidden">
                <h3>Dedicate to</h3>
                <select id="share-to"></select>
                <textarea id="share-message" placeholder="Say something about why this one matters..."></textarea>
                <button id="send-btn" class="btn btn-spotify">Send it over</button>
            </div>
        </section>

        <!-- COMPARE TAB -->
        <section id="compare" class="tab-content">
            <h2>Where our tastes collide</h2>
            <div class="compare-picker">
                <label>Compare with:</label>
                <select id="compare-user"></select>
                <button id="compare-btn" class="btn">Reveal</button>
            </div>
            <div id="compare-results" class="hidden">
                <div class="compat-score">
                    <span id="compat-number">0</span><span>%</span>
                    <p>musical kinship</p>
                </div>

                <div class="combined-chart">
                    <h3 class="chart-title">The Definitive Chart</h3>
                    <p class="chart-subtitle">Every song from both your top 50s, ranked together</p>
                    <div id="combined-tracks" class="song-list"></div>
                    <button id="show-more-chart" class="btn btn-expand hidden" onclick="toggleChart()">Show full chart <span id="chart-remaining"></span></button>
                </div>

                <div class="combined-chart">
                    <h3 class="chart-title">Just Played</h3>
                    <p class="chart-subtitle">What you've both been listening to recently</p>
                    <div class="recent-side-by-side">
                        <div class="recent-column">
                            <h4 class="recent-col-header" id="recent-left-name">You</h4>
                            <div id="recent-left" class="song-list">
                                <p class="loading">Checking the turntable...</p>
                            </div>
                        </div>
                        <div class="recent-column">
                            <h4 class="recent-col-header" id="recent-right-name">Them</h4>
                            <div id="recent-right" class="song-list">
                                <p class="loading">Checking the turntable...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="compare-grid">
                    <div>
                        <h3>Artists you both love</h3>
                        <ul id="shared-artists"></ul>
                    </div>
                    <div>
                        <h3>Your sound</h3>
                        <ul id="my-genres"></ul>
                    </div>
                    <div>
                        <h3>Their sound</h3>
                        <ul id="their-genres"></ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- MY TOP TAB -->
        <section id="my-top" class="tab-content">
            <h2>What's been on repeat</h2>
            <div id="top-tracks-list" class="song-list">
                <p class="loading">Flipping through the crates...</p>
            </div>
        </section>
        {% endif %}

        <div class="footer-quote" id="footer-quote">
            <span class="quote-text" id="quote-text">"One good thing about music, when it hits you, you feel no pain"</span>
            <span class="attr" id="quote-attr">Bob Marley</span>
        </div>
    </div>

    {% if logged_in %}
    <script>
        const MY_ID = "{{ user.id }}";
    </script>
    <script>
// --- Tab switching ---
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        const content = document.getElementById(tab.dataset.tab);
        content.classList.add('active');
        content.style.animation = 'none';
        content.offsetHeight;
        content.style.animation = null;
    });
});

// --- Helpers ---
async function api(url, opts = {}) {
    const resp = await fetch(url, {
        headers: { 'Content-Type': 'application/json' },
        ...opts,
    });
    if (!resp.ok) throw new Error(`API error ${resp.status}`);
    return resp.json();
}

function songCard(track, actions = '') {
    return `
        <div class="song-card" data-track-id="${track.id || ''}">
            ${track.album_image ? `<img src="${track.album_image}" alt="">` : ''}
            <div class="song-info">
                <div class="name">${track.name || track.track_name || ''}</div>
                <div class="artist">${track.artist || track.artist_name || ''}</div>
                ${track.meta ? `<div class="meta">${track.meta}</div>` : ''}
                ${track.spotify_url ? `<a class="spotify-link" href="${track.spotify_url}" target="_blank">Listen on Spotify</a>` : ''}
            </div>
            <div class="song-actions">${actions}</div>
        </div>
    `;
}

// --- Load feed ---
async function loadFeed() {
    const el = document.getElementById('feed-list');
    try {
        const songs = await api('/api/shared');
        if (songs.length === 0) {
            el.innerHTML = '<p class="loading">Nothing shared yet. Send the first song.</p>';
            return;
        }
        el.innerHTML = songs.map(s => {
            const isMine = s.from_user_id === MY_ID;
            const direction = isMine ? `You shared` : `From ${s.from_name}`;
            const meta = `${direction} ${s.message ? '~ "' + s.message + '"' : ''} ~ ${new Date(s.created_at).toLocaleDateString()}`;
            const likeActive = s.my_reaction === 'like' ? 'active' : '';
            const dislikeActive = s.my_reaction === 'dislike' ? 'active' : '';
            return songCard(
                { ...s, name: s.track_name, artist: s.artist_name, meta },
                `<button class="reaction-btn ${likeActive}" onclick="react(${s.id}, 'like', this)" title="Love it">&#x2764;</button>
                 <button class="reaction-btn ${dislikeActive}" onclick="react(${s.id}, 'dislike', this)" title="Not for me">&#x1F44E;</button>`
            );
        }).join('');
    } catch (e) {
        el.innerHTML = '<p class="loading">Could not load the record.</p>';
    }
}

async function react(songId, reaction, btn) {
    await api('/api/react', {
        method: 'POST',
        body: JSON.stringify({ shared_song_id: songId, reaction }),
    });
    const parent = btn.parentElement;
    parent.querySelectorAll('.reaction-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// --- Search & share ---
let selectedTrack = null;
let searchResultsCache = [];

document.getElementById('search-btn').addEventListener('click', async () => {
    const q = document.getElementById('search-input').value.trim();
    if (!q) return;
    searchResultsCache = await api(`/api/search?q=${encodeURIComponent(q)}`);
    document.getElementById('search-results').innerHTML = searchResultsCache.map((t, i) =>
        songCard(t, `<button class="share-btn" data-index="${i}">Share</button>`)
    ).join('');
});

document.getElementById('search-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('search-btn').click();
});

// Use event delegation for share buttons
document.getElementById('search-results').addEventListener('click', async (e) => {
    const btn = e.target.closest('.share-btn');
    if (!btn) return;
    const index = parseInt(btn.dataset.index, 10);
    const track = searchResultsCache[index];
    if (!track) return;

    selectedTrack = track;
    document.getElementById('share-form').classList.remove('hidden');
    // Scroll the form into view
    document.getElementById('share-form').scrollIntoView({ behavior: 'smooth', block: 'center' });
    const users = await api('/api/users');
    const sel = document.getElementById('share-to');
    sel.innerHTML = users.map(u => `<option value="${u.id}">${u.display_name}</option>`).join('');
    if (users.length === 0) sel.innerHTML = '<option disabled>No one else is here yet</option>';
});

document.getElementById('send-btn').addEventListener('click', async () => {
    if (!selectedTrack) return;
    const to = document.getElementById('share-to').value;
    const msg = document.getElementById('share-message').value;
    await api('/api/share', {
        method: 'POST',
        body: JSON.stringify({
            to_user_id: to,
            track_id: selectedTrack.id,
            track_name: selectedTrack.name,
            artist_name: selectedTrack.artist,
            album_image: selectedTrack.album_image,
            preview_url: selectedTrack.preview_url,
            spotify_url: selectedTrack.spotify_url,
            message: msg,
        }),
    });
    document.getElementById('share-form').classList.add('hidden');
    document.getElementById('share-message').value = '';
    selectedTrack = null;
    alert('Sent. Like a letter in a bottle.');
    document.querySelector('[data-tab="feed"]').click();
    loadFeed();
});

// --- Compare ---
async function loadCompareUsers() {
    try {
        const users = await api('/api/users');
        const sel = document.getElementById('compare-user');
        sel.innerHTML = users.map(u => `<option value="${u.id}">${u.display_name}</option>`).join('');
        if (users.length === 0) sel.innerHTML = '<option disabled>Waiting for a friend to join</option>';
    } catch (e) {}
}

document.getElementById('compare-btn').addEventListener('click', async () => {
    const otherId = document.getElementById('compare-user').value;
    if (!otherId) return;
    try {
        const data = await api(`/api/compare/${otherId}`);
        document.getElementById('compare-results').classList.remove('hidden');
        document.getElementById('compat-number').textContent = data.compatibility_score;
        document.getElementById('shared-artists').innerHTML = data.shared_artists.length
            ? data.shared_artists.map(a => `<li>${a}</li>`).join('')
            : '<li>No shared artists yet</li>';
        document.getElementById('my-genres').innerHTML = data.my_top_genres.map(g => `<li>${g}</li>`).join('');
        document.getElementById('their-genres').innerHTML = data.their_top_genres.map(g => `<li>${g}</li>`).join('');

        // Render combined chart (show top 10, hide rest)
        const ct = document.getElementById('combined-tracks');
        const showMoreBtn = document.getElementById('show-more-chart');
        const chartRemaining = document.getElementById('chart-remaining');
        if (data.combined_tracks && data.combined_tracks.length > 0) {
            ct.innerHTML = data.combined_tracks.map(t => {
                const myR = t.my_rank ? `Your #${t.my_rank}` : 'Not in your top 50';
                const theirR = t.their_rank ? `Their #${t.their_rank}` : 'Not in their top 50';
                const sharedClass = t.shared ? ' is-shared' : '';
                const hiddenClass = t.combined_rank > 10 ? ' chart-hidden' : '';
                const sharedLabel = t.shared ? '<span class="shared-badge"> \u2022 Both of you</span>' : '';
                return `
                    <div class="song-card${sharedClass}${hiddenClass}">
                        <div class="combined-rank">#${t.combined_rank}</div>
                        ${t.album_image ? `<img src="${t.album_image}" alt="">` : ''}
                        <div class="song-info">
                            <div class="name">${t.name}</div>
                            <div class="artist">${t.artist}</div>
                            <div class="rank-detail">${myR} \u00B7 ${theirR}${sharedLabel}</div>
                            ${t.spotify_url ? `<a class="spotify-link" href="${t.spotify_url}" target="_blank">Listen on Spotify</a>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            // Show expand button if more than 10 tracks
            if (data.combined_tracks.length > 10) {
                const remaining = data.combined_tracks.length - 10;
                chartRemaining.textContent = `(${remaining} more)`;
                showMoreBtn.classList.remove('hidden');
            } else {
                showMoreBtn.classList.add('hidden');
            }
        }

        // Load recently played for both users
        loadRecentTracks();
    } catch (e) {
        alert('Could not compare. Make sure you\'re both connected.');
    }
});

// --- Chart expand/collapse ---
window.toggleChart = function() {
    const cards = document.querySelectorAll('#combined-tracks .song-card.chart-hidden');
    const btn = document.getElementById('show-more-chart');
    const isExpanded = btn.dataset.expanded === 'true';

    if (isExpanded) {
        // Collapse: hide cards beyond top 10
        document.querySelectorAll('#combined-tracks .song-card').forEach((card, i) => {
            if (i >= 10) card.classList.add('chart-hidden');
        });
        btn.innerHTML = 'Show full chart <span id="chart-remaining">(' + (document.querySelectorAll('#combined-tracks .song-card').length - 10) + ' more)</span>';
        btn.dataset.expanded = 'false';
        // Scroll back to chart top
        document.querySelector('.combined-chart').scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        // Expand: show all
        document.querySelectorAll('#combined-tracks .song-card').forEach(card => {
            card.classList.remove('chart-hidden');
        });
        btn.innerHTML = 'Show top 10 only';
        btn.dataset.expanded = 'true';
    }
};

// --- My top tracks ---
async function loadTopTracks() {
    const el = document.getElementById('top-tracks-list');
    try {
        const tracks = await api('/api/me/top-tracks');
        el.innerHTML = tracks.length
            ? tracks.map((t, i) => songCard({ ...t, meta: `#${i + 1}` })).join('')
            : '<p class="loading">No listening history yet. Play some records.</p>';
    } catch (e) {
        el.innerHTML = '<p class="loading">Could not load your catalogue.</p>';
    }
}

// --- Recently played (side by side) ---
async function loadRecentTracks() {
    const leftEl = document.getElementById('recent-left');
    const rightEl = document.getElementById('recent-right');
    const leftName = document.getElementById('recent-left-name');
    const rightName = document.getElementById('recent-right-name');
    try {
        const tracks = await api('/api/recently-played');
        const mine = tracks.filter(t => t.user_id === MY_ID);
        const theirs = tracks.filter(t => t.user_id !== MY_ID);

        // Set column headers
        leftName.textContent = 'You';
        if (theirs.length > 0) {
            rightName.textContent = theirs[0].user_name;
        }

        leftEl.innerHTML = mine.length
            ? mine.map(t => songCard({ ...t, meta: timeAgo(t.played_at) })).join('')
            : '<p class="loading">Nothing played recently.</p>';

        rightEl.innerHTML = theirs.length
            ? theirs.map(t => songCard({ ...t, meta: timeAgo(t.played_at) })).join('')
            : '<p class="loading">Nothing played recently.</p>';
    } catch (e) {
        leftEl.innerHTML = '<p class="loading">Could not load recent plays.</p>';
        rightEl.innerHTML = '<p class="loading">Could not load recent plays.</p>';
    }
}

function timeAgo(isoDate) {
    const diff = Date.now() - new Date(isoDate).getTime();
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    const days = Math.floor(hrs / 24);
    return `${days}d ago`;
}

// --- Init ---
loadFeed();
loadTopTracks();
loadCompareUsers();
    </script>
    {% endif %}

    <script>
    // --- Rotating footer lyrics from user's top 50 songs ---
    const defaultQuotes = [
        { text: "One good thing about music, when it hits you, you feel no pain", attr: "Bob Marley" },
    ];

    let footerQuotes = defaultQuotes;
    let quoteIndex = 0;
    const quoteText = document.getElementById('quote-text');
    const quoteAttr = document.getElementById('quote-attr');

    // Load actual lyrics from the user's top 50 tracks
    {% if logged_in %}
    (async function() {
        try {
            const resp = await fetch('/api/me/top-lyrics', {
                headers: { 'Content-Type': 'application/json' }
            });
            if (resp.ok) {
                const lyrics = await resp.json();
                if (lyrics.length > 0) {
                    footerQuotes = lyrics;
                    // Set the first one immediately
                    if (quoteText && quoteAttr) {
                        quoteText.textContent = '\u201C' + footerQuotes[0].text + '\u201D';
                        quoteAttr.textContent = footerQuotes[0].attr;
                    }
                }
            }
        } catch(e) {
            console.log('Lyrics fetch failed, using default quote');
        }
    })();
    {% endif %}

    if (quoteText && quoteAttr) {
        setInterval(() => {
            quoteText.classList.add('fade-out');
            quoteAttr.classList.add('fade-out');

            setTimeout(() => {
                quoteIndex = (quoteIndex + 1) % footerQuotes.length;
                quoteText.textContent = '\u201C' + footerQuotes[quoteIndex].text + '\u201D';
                quoteAttr.textContent = footerQuotes[quoteIndex].attr;
                quoteText.classList.remove('fade-out');
                quoteAttr.classList.remove('fade-out');
            }, 600);
        }, 10000);
    }
    </script>
</body>
</html>
